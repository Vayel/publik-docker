#!/bin/bash

set -eu

SUBST_STR='$DOMAIN $ADMIN_MAIL_ADDR $ADMIN_MAIL_AUTHOR $RABBITMQ_HOST $RABBITMQ_DEFAULT_USER $AUTHENTIC_SUBDOMAIN $COMBO_SUBDOMAIN $COMBO_ADMIN_SUBDOMAIN $FARGO_SUBDOMAIN $HOBO_SUBDOMAIN $PASSERELLE_SUBDOMAIN $WCS_SUBDOMAIN $LOG_LEVEL $DEFAULT_POSITION $HOBO_DEPLOY_TIMEOUT $HOBO_DEPLOY_VERBOSITY $DEBUG $ENV $ALLOWED_HOSTS $SMTP_USER $DB_ADMIN_USER $DB_HOST $DB_PORT $RABBITMQ_PORT $RABBITMQ_MANAGEMENT_PORT $HTTP_PORT $HTTPS_PORT $SMTP_HOST $SMTP_PORT $DOCKER_PROJECT_NAME $POSTGRES_PASSWORD $DB_AUTHENTIC_PASS $DB_COMBO_PASS $DB_FARGO_PASS $DB_HOBO_PASS $DB_PASSERELLE_PASS $DB_WCS_PASS $RABBITMQ_DEFAULT_PASS $SUPERUSER_PASS $SMTP_PASS'

if [ "$#" -lt 2 ]; then
  echo "Help: subst.sh <template-file> <dest-file> [subst-str]"
  exit 1
fi
if [ "$#" -eq 3 ]; then
  SUBST_STR=$3
fi

SRC="$1"
DEST="$2"
envsubst "$SUBST_STR" < "$SRC" > "$DEST.tmp"
encoding=`file -i "$DEST.tmp" | cut -f 2 -d";" | cut -f 2 -d=`
iconv -f $encoding -t utf-8 "$DEST.tmp" > "$DEST"
rm "$DEST.tmp"
