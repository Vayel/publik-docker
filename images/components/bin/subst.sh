#!/bin/bash

set -eu

SUBST_STR='$DOMAIN $ADMIN_MAIL_ADDR $ADMIN_MAIL_AUTHOR $RABBITMQ_HOST $RABBITMQ_USER $AUTHENTIC_SUBDOMAIN $COMBO_SUBDOMAIN $COMBO_ADMIN_SUBDOMAIN $CHRONO_SUBDOMAIN $FARGO_SUBDOMAIN $HOBO_SUBDOMAIN $PASSERELLE_SUBDOMAIN $WCS_SUBDOMAIN $LOG_LEVEL $DEFAULT_POSITION $HOBO_DEPLOY_TIMEOUT $SECRET_KEY $DEBUG $ENV $ALLOWED_HOSTS $SMTP_USER $DB_ADMIN_USER $DB_HOST $DB_PORT $RABBITMQ_PORT $RABBITMQ_MANAGEMENT_PORT $HTTP_PORT $HTTPS_PORT $SMTP_HOST $SMTP_PORT $DOCKER_PROJECT_NAME $PASS_POSTGRES $PASS_DB_AUTHENTIC $PASS_DB_COMBO $PASS_DB_CHRONO $PASS_DB_FARGO $PASS_DB_HOBO $PASS_DB_PASSERELLE $PASS_DB_WCS $PASS_RABBITMQ $PASS_SUPERUSER $PASS_SMTP $FROM_EMAIL $EMAIL_SUBJECT_PREFIX $EMAIL_SENDER_NAME $EMAIL_REGISTRATION_OPEN $DB_AUTHENTIC $DB_CHRONO $DB_COMBO $DB_FARGO $DB_HOBO $DB_PASSERELLE $USER_DB_AUTHENTIC $USER_DB_CHRONO $USER_DB_COMBO $USER_DB_FARGO $USER_DB_HOBO $USER_DB_PASSERELLE $USER_DB_WCS'

if [ "$#" -lt 2 ]; then
  echo "Help: subst.sh <template-file> <dest-file> [subst-str]"
  exit 1
fi
if [ "$#" -eq 3 ]; then
  SUBST_STR=$3
fi

SRC="$1"
DEST="$2"
envsubst "$SUBST_STR" < "$SRC" > "$DEST.tmp"
encoding=`file -i "$DEST.tmp" | cut -f 2 -d";" | cut -f 2 -d=`
iconv -f $encoding -t utf-8 "$DEST.tmp" > "$DEST"
rm "$DEST.tmp"
